# Task1:

```mysql
create table account(
    a_name varchar(30) primary key,
    a_pass varchar(10) not null,
    check ( a_pass regexp '[a-zA-Z0-9]{4,10}')
);

create table book(
    b_isbn char(13) primary key,
    b_name varchar(30) not null,
    b_num int default 0
);

create table record(
    ra_name varchar(30) not null,
    rb_isbn char(13) not null,
    r_ltime date not null,
    r_etime date not null,
    r_rtime date default null,
    primary key (ra_name,rb_isbn),
    foreign key (ra_name) references account(a_name),
    foreign key (rb_isbn) references book(b_isbn)
);

# 1-1
create procedure check_update_account(
    in user_name varchar(30),
    in pass_old varchar(10),
    in pass_new varchar(10),
    in action_num int
)
begin
    declare user_exists int default 0;
    declare user_cursor cursor for select count(*) from account where user_name = a_name and a_pass = pass_old;
    open user_cursor;
    fetch user_cursor into user_exists;
    close user_cursor;
    if user_exists = 0 then
        select false;
    elseif action_num = 1 then
        select true;
    elseif action_num = 2 then
        if pass_new regexp '^[a-zA-Z0-9]{4,10}$' then
            update account set a_pass = pass_new where a_name = user_name;
            select true;
        else
            select false;
        end if;
    end if;
end;

# 1-2
create procedure borrow_book(
    in username varchar(30),
    in isbn char(13)
)
BEGIN
    declare num int;
    if not exists(select * from account where a_name = username) or not exists(select * from book where isbn = b_isbn) or exists(select * from record where ra_name = username and rb_isbn = isbn) then
        select false;
    else
        select b_num from book where isbn = b_isbn into num;
        if num<=0 then
            select false;
        else
            insert into record(ra_name, rb_isbn, r_ltime, r_etime) values(username, isbn,curdate(),date_add(curdate(),interval 30 day));
            update book set b_num = num-1 where b_isbn = isbn;
        end if;
    end if;
end;

# 1-3
create procedure return_book(
    in username varchar(30),
    in isbn char(13)
)
BEGIN
    declare num int;
    if not exists(select * from record where username = ra_name and isbn = rb_isbn and r_rtime is null) then
        select false;
    else
        select b_num from book where isbn = b_isbn into num;
        update record set r_rtime = curdate() where rb_isbn = isbn and username = ra_name;
        update book set b_num = num+1 where b_isbn = isbn;
    end if;
end;

# 1-4
create procedure look_record(
    in username varchar(20)
)
BEGIN
    select ra_name,rb_isbn,r_etime from record where username = ra_name and r_rtime is null;
end;
```

![image-20230427143606334](C:\Users\伍丹阳\AppData\Roaming\Typora\typora-user-images\image-20230427143606334.png)

![image-20230427143905546](C:\Users\伍丹阳\AppData\Roaming\Typora\typora-user-images\image-20230427143905546.png)

### 1-1：

![image-20230427143145140](C:\Users\伍丹阳\AppData\Roaming\Typora\typora-user-images\image-20230427143145140.png)

![image-20230427143325700](C:\Users\伍丹阳\AppData\Roaming\Typora\typora-user-images\image-20230427143325700.png)

![image-20230427143411453](C:\Users\伍丹阳\AppData\Roaming\Typora\typora-user-images\image-20230427143411453.png)

![image-20230427143627944](C:\Users\伍丹阳\AppData\Roaming\Typora\typora-user-images\image-20230427143627944.png)

### 1-2：

```mysql
call borrow_book('cary','1231231231231');
call borrow_book('cary','1231231231232');
call borrow_book('cary','1231231231233');
call borrow_book('cary','1231231231234');
call borrow_book('cary','1231231231235');
call borrow_book('cary','1231231231236');
call borrow_book('cary','1231231231237');
call borrow_book('caryz','1231231231232');
call borrow_book('vioriey','1231231231231');
call borrow_book('vioriey','1231231231232');
call borrow_book('vioriey','1231231231233');
call borrow_book('vioriey','1231231231234');
call borrow_book('vioriey','1231231231234');
call borrow_book('vioriey','1231231231235');
call borrow_book('vioriey','1231231231236');
call borrow_book('carry','1231231231231');
call borrow_book('carry','1231231231232');
call borrow_book('carry','1231231231233');
call borrow_book('carry','1231231231234');
call borrow_book('carry','1231231231235');
call borrow_book('carry','1231231231236');
```

![image-20230427150500704](C:\Users\伍丹阳\AppData\Roaming\Typora\typora-user-images\image-20230427150500704.png)

![image-20230427150530104](C:\Users\伍丹阳\AppData\Roaming\Typora\typora-user-images\image-20230427150530104.png)

### 1-3：

```mysql
call return_book('cary','1231231231231');
call return_book('cary','1231231231231');
call return_book('cary','1231231231234');
call return_book('cary','1231231231233');
call return_book('cary','1231231231237');
call return_book('caryz','1231231231234');
call return_book('vioriey','1231231231232');
call return_book('carry','1231231231235');
```

![image-20230427151038246](C:\Users\伍丹阳\AppData\Roaming\Typora\typora-user-images\image-20230427151038246.png)

![image-20230427150955300](C:\Users\伍丹阳\AppData\Roaming\Typora\typora-user-images\image-20230427150955300.png)

### 1-4：

![image-20230427151332831](C:\Users\伍丹阳\AppData\Roaming\Typora\typora-user-images\image-20230427151332831.png)

![image-20230427151348364](C:\Users\伍丹阳\AppData\Roaming\Typora\typora-user-images\image-20230427151348364.png)

![image-20230427151401636](C:\Users\伍丹阳\AppData\Roaming\Typora\typora-user-images\image-20230427151401636.png)

![image-20230427151422515](C:\Users\伍丹阳\AppData\Roaming\Typora\typora-user-images\image-20230427151422515.png)

# Task2:

![image-20230427141009744](C:\Users\伍丹阳\AppData\Roaming\Typora\typora-user-images\image-20230427141009744.png)

```mysql
create table bdtable(
    id mediumint unsigned primary key auto_increment,
    sparse mediumint unsigned not null check ( 0 <= sparse <= 5000000 ),
    dense tinyint not null check ( 0 <= dense <= 9 )
);

create procedure insert_record(
    in num_record int
)
BEGIN
    declare i int default 1;
    while i <= num_record do
        insert into bdtable(sparse, dense) values (FLOOR(RAND() * 5000001), FLOOR(RAND() * 10));
        set i=i+1;
        end while;
end;

# call insert_record(400000);     # 2-1
call insert_record(4000000);    # 2-2
```

